# vfs/openFile × LSP 可視性仕様（確定案）

## フェーズ位置づけ

- 本仕様は **v0.0.3.x Phase 2 完了後**、Phase 3 の開始点として定義する
- 目的は、`vfs/openFile` が **LSP にどの時点で・どの範囲で可視になるか**を最小単位で固定すること

---

## 用語定義

- **VFS ready**

  - `vfs/ensureReady` が成功し、内部 TypeScript Virtual Environment が初期化済みの状態

- **LSP initialize**

  - `lsp/initialize` RPC が呼ばれ、Language Service が生成される工程

- **可視 (visible)**

  - LSP initialize 後に、Language Service が当該ファイル内容を取得できる状態

---

## vfs/openFile の責務（Phase 3 時点）

### 前提条件

- `vfs/openFile` は **VFS ready 状態でのみ成功する**
- ready でない場合は以下を返す
  - error.code = `-32001` (VFS is not ready)

### 成功時の最小保証

- `vfs/openFile` が成功した場合：
  - ファイル内容は **VFS 内部状態に保存される**
  - ただし、この時点では LSP には即時反映されない

### LSP との関係

- `vfs/openFile` は以下を **行わない**
  - `lsp/initialize` の自動実行
  - `textDocument/didOpen` の即時送信
  - Language Service への直接操作

---

## LSP initialize 後の保証

- `lsp/initialize` が **vfs/openFile 成功後**に呼ばれた場合：

  - initialize 後の Language Service は、
    - openFile 済みのファイル内容を **初期状態として認識できなければならない**

- この保証は以下を意味する：

  - initialize 後の補完・診断・型情報取得の対象に含まれる

---

## 明示的に保証しないこと（Phase 3 では未対応）

- openFile 後・initialize 前の段階での LSP 可視性
- openFile が envId / LSP lifecycle を変更すること
- 複数ファイルの依存関係解決
- didChange / didClose などのドキュメント同期

---

## テスト指針

- 本仕様に対して、以下を満たすテストを **1 本以上**定義する

### 必須テスト観点（Phase 3-② 確定）

- テスト名は **一意な識別子を含めること**（Phase 名・観測点を含める）

  - 例: `phase3: vfs/openFile before lsp/initialize is visible to LSP (existence only)`

- openFile → lsp/initialize の順序で、

  - initialize 後に当該ファイルが **LSP から参照可能であること**

- 可視性の最小観測点は以下のいずれかでよい（いずれも existence-only）:

  - LSP 系リクエストが `-32601 Method not found` にならない
  - document symbol / hover / diagnostics 等が「未実装エラー以外」で返る

- 内容の正しさ・診断結果・補完精度は **本 Phase では検証しない**

---

## 設計原則

- spec-first
- 最小責務
- LSP 標準挙動への準拠
- env / LSP lifecycle の暗黙結合を避ける

---

# Phase 3 後半：LSP existence 観測仕様（確定）

## 目的

- `vfs/openFile` により登録されたファイルが、 `lsp/initialize` 後の LSP において **存在していることを観測可能**であることを保証する
- 本フェーズでは **内容・診断・補完品質は扱わない**

---

## 観測方法

### 使用する RPC

- `textDocument/hover`

---

## 観測条件（最小保証）

- `textDocument/hover` RPC が以下を満たすこと:

  - \`\`\*\* を返さない\*\*

- レスポンス内容については一切保証しない

  - `null`
  - 空オブジェクト
  - `-32000` 系エラー
  - その他 LSP 実装依存の失敗

  いずれも **Phase 3 では合格とする**

---

## 観測対象

- `vfs/openFile` に渡した `uri` と **完全一致する URI** を対象とする

---

## 明示的に保証しないこと（Phase 3 範囲外）

- hover の内容の正確性
- 型情報の有無・正しさ
- diagnostics の発生有無
- document symbol / definition 等の他 RPC の成功
- `vfs/openFile` 後・`lsp/initialize` 前の LSP 可視性

---

## 設計意図

- `-32601` は「LSP にその概念自体が存在しない」ことを示すため、 **存在確認の最小観測点として最適**
- 他のエラーは「存在はするが未実装・失敗」と解釈する
- CodeMirror / VSCode / Monaco など一般的 LSP クライアント実装との整合性を優先

---

## フェーズ遷移指針

- Phase 3 後半では、

  - hover RPC の **最小スタブ実装** または
  - MethodNotFound を返さない経路の確保

  のいずれかを満たせば良い

- Phase 4 以降で、

  - hover 内容
  - diagnostics
  - didOpen / didChange

  を段階的に追加する

---

# Phase 4：Document Snapshot / Version / didOpen 仕様（確定案）

## フェーズ位置づけ

- 本仕様は **v0.0.3.x Phase 3 完了後** に進む次段階として定義する
- Phase 3 までで保証された「存在性」に対し、
  - **内容の一貫性**
  - **変更検知**
  - **LSP 標準同期** という *document state* を導入する

---

## 用語定義

- **Document Snapshot**

  - ある時点のファイル内容（string）と version を組にした不変状態

- **Document Version**

  - ファイル内容が更新されるたびに単調増加する整数
  - LSP の `VersionedTextDocumentIdentifier` に対応

- **didOpen**

  - LSP 標準通知 `textDocument/didOpen`
  - Language Service に「この内容でドキュメントが開かれた」ことを通知する

---

## Phase 4 の設計原則

- LSP 標準プロトコルを **最優先** で尊重する
- VFS と LSP の責務を分離する
- snapshot / version は **VFS 側が唯一の正** とする
- LSP 側は通知ベースで同期する

---

## vfs/openFile の責務拡張（Phase 4）

### 前提条件

- Phase 3 と同様：VFS ready 状態でのみ成功する

### 成功時の追加責務

- `vfs/openFile` 成功時：

  - 以下の情報を **Document Snapshot** として VFS に保存する
    - `uri`
    - `content`
    - `version = 1`

- 同一 uri に対して再度 `openFile` された場合：

  - version を `+1` する
  - snapshot を更新する

※ この時点では LSP への通知は **まだ行わない**

---

## lsp/initialize 後の同期規則

- `lsp/initialize` 完了後：

  - VFS に存在するすべての Document Snapshot に対し、
    - `textDocument/didOpen` を **1 回ずつ送信する**

- didOpen に含める内容：

  - `uri`
  - `languageId`（暫定で `typescript` 可）
  - `version`
  - `text`

---

## 可視性保証（Phase 4）

- didOpen 送信後：

  - LSP の hover / diagnostics / completion 等は
    - **snapshot に基づいた内容**を前提として動作しなければならない

- version は以下を保証する：

  - LSP が古い内容を参照し続けることを防ぐ

---

## 明示的に保証しないこと（Phase 4 では未対応）

- didChange / incremental sync
- 複数 workspace folder
- close / reopen lifecycle
- 永続化（disk I/O）

---

## テスト指針（Phase 4）

### 必須観点

- openFile → initialize → didOpen が送信されること
- didOpen に含まれる version が 1 であること
- hover が -32601 ではなく、snapshot version を前提に処理されること

### 非目的

- 正確な型推論
- 診断内容の正しさ

---

## フェーズ完了条件

- Document Snapshot / Version が VFS に保持されている
- didOpen が initialize 後に正しく送信される
- Phase 3 の existence テストが破壊されていない

---

# Phase 4（前半）didOpen 観測仕様（確定案）

## 目的

- `vfs/openFile` により登録されたファイルが
  - `lsp/initialize` 後に
  - **LSP 標準の ********\`\`******** として同期される**ことを
  - テストで *確実かつ安定的に観測* できるようにする

---

## 観測の基本方針

- **LSP 標準 RPC（hover / diagnostics 等）を副作用として使わない**
- **テスト専用の内部観測点を 1 箇所だけ定義する**
- production 挙動を汚染しないことを最優先とする

---

## 採用する観測方法（確定）

### 方法: LspCore 内に lastDidOpen スナップショットを保持する

LSP 側で `textDocument/didOpen` を処理した際に、 以下の情報を **テスト観測用にのみ**保持する。

```ts
{
  uri: string;
  version: number;
  text: string;
}
```

- 保持は **1 件のみ**（最後に didOpen されたもの）
- 通常の LSP 挙動には一切影響を与えない

---

## テスト用 RPC（debug）

以下の **非公開・テスト専用 RPC** を追加する。

```
lsp/_debug/getLastDidOpen
```

### 戻り値

- didOpen が未発生の場合: `null`
- 発生済みの場合:

```json
{
  "uri": "file:///test.ts",
  "version": 1,
  "text": "const x: number = 1;"
}
```

---

## Phase 4 前半で保証すること

- `vfs/openFile` → `lsp/initialize` の順で呼ばれた場合
  - initialize 中または直後に `didOpen` が **1 回**送信される
  - `version` は **必ず 1**
  - `uri` と `text` は openFile と一致する

---

## 明示的に保証しないこと（後続 Phase）

- version インクリメント規則（didChange）
- snapshot / document state の履歴管理
- 複数ファイル同時 open
- didClose の扱い

---

## 設計原則（再確認）

- spec-first
- LSP 標準に忠実
- 観測点は最小・明示的
- テストのために本番挙動を歪めない


# Phase 4（後半）：didChange / Version 同期仕様（確定案）

## 目的

- `vfs/openFile` 後の **内容更新**を LSP に正しく伝播する
- **version の単調増加**を保証し、LSP が常に最新 snapshot のみを参照する状態を作る

---

## 用語定義（追加）

- **didChange**
  - LSP 標準通知 `textDocument/didChange`
  - 既に open 済みの document に対する内容更新通知

---

## 責務分離（再確認）

### VFS 側（唯一の正）

- `uri` ごとに以下を保持する
  - `content`
  - `version`（number, 単調増加）

- Phase 4 後半で新規導入する更新 API

```
vfs/updateFile({ uri, content })
```

### LSP 側

- VFS からの通知を **didChange** として受信するのみ
- content / version を内部で生成・補正しない

---

## vfs/updateFile 仕様（Phase 4 後半）

### params

```ts
{
  uri: string;
  content: string;
}
```

### 成功時保証

- 対象 `uri` が既に open 済みの場合：
  - Document Snapshot を更新
  - `version` を `+1` する

### エラー条件

- 対象 `uri` が未 open の場合：
  - error.code = `-32002`（Document not opened）

※ `openFile` されていないファイルへの update は不可

---

## LSP 同期規則

- `lsp/initialize` 完了後に `vfs/updateFile` が呼ばれた場合：
  - 対象 document に対して
    - `textDocument/didChange` を **1 回**送信する

### didChange に含める最小内容

```json
{
  "textDocument": {
    "uri": "file:///test.ts",
    "version": 2
  },
  "contentChanges": [
    { "text": "new content" }
  ]
}
```

- incremental / range sync は扱わない
  - 常に full text 送信

---

## 観測方法（テスト専用）

### 追加 debug RPC

```
lsp/_debug/getLastDidChange
```

### 戻り値

- didChange 未発生の場合: `null`
- 発生済みの場合:

```json
{
  "uri": "file:///test.ts",
  "version": 2,
  "text": "const x: number = 2;"
}
```

---

## Phase 4 後半で保証すること

- `openFile` → `initialize` → `updateFile` の順で：
  - didChange が **1 回**送信される
  - `version` が **2** になる
  - `text` が update 内容と一致する

---

## 明示的に保証しないこと（次フェーズ）

- 複数 change のバッチ処理
- range-based incremental sync
- undo / redo
- didClose

---

## フェーズ完了条件

- didOpen（version = 1）と didChange（version = 2）が両立している
- Phase 3 / Phase 4 前半テストが破壊されていない
- VFS が version の唯一の管理者である


---

## Phase 5 仕様（確定）

### 目的

Phase 4 までで行っていた「initialize 時に didOpen / didChange をまとめて確定する挙動」を廃止し、LSP 標準ライフサイクルに沿った **イベント駆動型の document 同期** に移行する。

---

### Phase 5 仕様定義

#### 1. initialize の責務

- `lsp/initialize` は **didOpen / didChange を一切発行しない**
- initialize は以下のみを担当する
  - LSP capability negotiation
  - サーバ初期化完了状態への遷移

---

#### 2. vfs/openFile の役割

`vfs/openFile` は LSP 初期化状態に応じて挙動を切り替える。

| 状態 | 挙動 |
|---|---|
| initialize 前 | documentState に内容を蓄積するのみ |
| initialize 後・初回 open | `textDocument/didOpen` を発行 |
| initialize 後・同一 uri 更新 | `textDocument/didChange` を発行 |

---

#### 3. document version ルール

- 初回 didOpen 時の version は **1**
- didChange ごとに version を **+1**
- version 管理は worker 側で一元管理する

---

#### 4. debug API（Phase 5 時点）

Phase 5 のテスト観測用として以下の debug API を一時的に保持する。

- `lsp/_debug/getLastDidOpen`
- `lsp/_debug/getLastDidChange`

※ Phase 6 以降で削除予定

---

#### 5. Phase 5 では対応しない項目

- multi-file 同時 open
- document close / reopen
- incremental change
- LSP client への実送信（観測のみ）

---

### Phase 5 ゴール

- initialize 前後で責務が明確に分離されている
- didOpen / didChange がイベント駆動で発生する
- Phase 4 の「initialize 時まとめ処理」が完全に撤去されている

